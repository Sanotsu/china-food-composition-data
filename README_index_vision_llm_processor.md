# 调用视觉大模型 API 识别中国食物成分表营养素截图

调用视觉大模型 API，识别出项目中《中国食物成分表标准版第 6 版》的[营养素截图](营养素截图)文件夹下、图片中的“能量和食物一般营养成分”表格数据，并转换为 json 文件。

## 安装

1. 克隆此仓库到本地
2. 安装脚本需要的依赖

```bash
pip install -r requirements.txt
```

3. 复制环境变量示例文件并配置

```bash
cp .env.example .env
# 编辑.env文件，设置API密钥和其他参数
```

## 使用方法

### 基本用法

```bash
python index_vision_llm_processor.py
```

这将使用默认设置处理 `营养素截图` 目录中的图片，并将结果保存到`json_data_vision`目录。

```sh
# 调用大模型处理耗时:
# python index_vision_llm_processor.py --worker 10
2025-07-23 16:45:44,750 - INFO - 开始处理图像:
2025-07-23 16:45:44,750 - INFO - 输入目录: 营养素截图
2025-07-23 16:45:44,750 - INFO - 输出目录: json_data_vision
2025-07-23 16:45:44,750 - INFO - 并发工作数: 10
2025-07-23 16:45:44,750 - INFO - 最大重试次数: 3
2025-07-23 16:45:44,750 - INFO - 模型名称: qwen2.5-vl-72b-instruct
2025-07-23 16:45:44,750 - INFO - 最大响应token数: 4096
2025-07-23 16:45:44,750 - INFO - 温度参数: 0.1
2025-07-23 16:45:44,822 - INFO - 找到 154 对图像，共 308 个文件需要处理
2025-07-23 16:45:44,823 - INFO - 开始处理: 乳类及其制品-其他
……
……
2025-07-23 16:58:56,969 - INFO - 所有合并后的JSON文件已保存到 json_data_vision 目录
2025-07-23 16:58:56,970 - INFO -
处理完成! 用时 0:13:12
成功处理: 154 对图像
失败处理: 0 对图像
成功率: 100.0%
平均每对图像处理时间: 5.14 秒
```

会默认在项目中创建几个临时文件夹，更方便调试和比较识别结果:

```txt
temp/temp_successful_responses : 调用大模型API成功的响应内容
temp/temp_failed_responses: 调用大模型API失败的响应内容
temp/temp_middle_jsons: 解析图片对数据产生的中间json文件
index_vision_llm_processor.log :终端输出日志
```

### 高级用法

```bash
python index_vision_llm_processor.py \
--input <图片目录> \
--output <输出目录> \
--workers 10 \
--retries 3 \
--api-key <API密钥> \
--model <模型名> \
--max-tokens 4000 \
--temperature 0.1
```

参数说明(大都可在`.env`中配置)：

- `--input`: 输入图片目录
- `--output`: 输出 JSON 目录
- `--workers`: 最大并发工作数，可以根据 API 限制和系统性能调整
- `--retries`: 最大重试次数
- `--api-key`: API 密钥
- `--api-base`: API 基础 URL
- `--model`: 模型名称
- `--max-tokens`: 最大响应 token 数
- `--temperature`: 温度参数（默认: 0.1）
- `--sort-only`: 仅对指定目录中的 JSON 文件进行排序，不进行图片处理

## 并行处理

工具使用异步并发处理技术，可以同时处理多个图片对。  
通过设置`--workers`参数可以控制同时处理的图片对数量。  
例如，设置`--workers 10`将允许同时处理 10 对图片，大幅提高处理速度。

处理流程：

1. 收集所有匹配的图片对（同名的`xxx-energy.png`和`xxx-netrient.png`为一对）
2. 创建一个工作池，同时处理多个图片对
3. 当某个图片对处理完成后，自动从队列中获取下一个待处理的图片对
4. 所有图片对处理完成后，按类别合并数据并保存为 JSON 文件

## 表格解析策略

一般视觉大模型输出 token 都是 4k，如果直接让其构建 json 格式数据可能会不完整(实测整页截图的一定会不完整)，所以提示词输出表格 markdown 代码：

1. **表格形式输出**：要求模型以纯文本表格形式输出数据，而不是 JSON 格式，减少 token 消耗
2. **本地解析处理**：在代码中实现表格文本到结构化数据的解析，确保完整性
3. **智能列匹配**：根据列名和位置自动匹配表格数据，处理可能的格式不一致问题
4. **数据验证**：对解析后的数据进行简单验证，确保关键字段存在

## 图片命名规则

目前截图是按以下格式命名：

- 能量数据图片: `[类别]-[子类][编号]-energy.png`
- 营养素数据图片: `[类别]-[子类][编号]-nutrient.png`

例如：`鱼虾蟹贝类-鱼1-energy.png` 和 `鱼虾蟹贝类-鱼1-nutrient.png` 将被识别为一对图片，并与 `鱼虾蟹贝类-鱼2-energy.png` 和 `鱼虾蟹贝类-鱼2-nutrient.png` 等同类食品合并到同一个 JSON 文件中。

## 输出格式

每个食品类别会生成一个合并的 JSON 文件，包含以下字段（来自能量表和营养素表）：

```json
[
  {
    "foodCode": "121101",
    "foodName": "白条鱼（裸鱼）",
    "edible": "59",
    "water": "76.8",
    "energyKCal": "103",
    ...
    "niacin": "1.90",
    "vitaminC": "Tr",
    ...
  },
  ...
]
```

## 类别合并规则

工具会自动从文件名中提取食品类别，例如：

- `鱼虾蟹贝类-鱼1-energy.png` → 类别为 `鱼虾蟹贝类-鱼`
- `鱼虾蟹贝类-鱼2-energy.png` → 类别为 `鱼虾蟹贝类-鱼`

同一类别的所有图片数据会被合并到一个 JSON 文件中，文件名为类别名称，例如 `鱼虾蟹贝类-鱼.json`。

## 注意事项

- 和飞桨识别的那个是完全分开的，应该各不影响
- 设置合适的并发数量可以提高处理速度，但过高的并发可能会导致 API 限流
- 同样的，是绝大模型处理，更无法保证数据识别的绝对一致；
- 所有版权都归原作者所有，有任何必要的话请通知我删除此仓库。
